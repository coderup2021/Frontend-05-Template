<script>
    /*实现reactivity  优化 effect性能 */
    let callbacks = new Map()
    let usedReactivities = [] 
    let object = {
        a: {x:1},
        b: 2
    }

    function effect(callback){
        // callbacks.push(callback)
        usedReactivities = []
        callback()

        for(let reactivity of usedReactivities){
            if(!callbacks.has(reactivity[0])) 
                callbacks.set(reactivity[0], new Map())
            if(!callbacks.get(reactivity[0]).has(reactivity[1])) 
                callbacks.get(reactivity[0]).set(reactivity[1], [])
            callbacks.get(reactivity[0]).get(reactivity[1]).push(callback)
            console.log(callbacks)
        }
    }

    function reactive(obj){
        let po = new Proxy(obj, {
            set(obj, prop, value){
                if(callbacks.get(obj))
                    if(callbacks.get(obj).get(prop))
                        for(const callback of callbacks.get(obj).get(prop))
                            callback()
                obj[prop] = value
                return obj[prop]
            },
            get(obj, prop){
                usedReactivities.push([obj, prop])
                return obj[prop]
            }
        })
        return po
    }
    const po = reactive(object)

    effect(()=>{
        console.log('effect:', po.a.x, po.b)
    })

    // po.a = 10
    console.log(po)
</script>